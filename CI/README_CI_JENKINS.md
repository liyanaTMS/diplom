# –ü–æ–¥–Ω—è—Ç–∏–µ Jenkins —Å Docker (Docker-in-Docker) üöÄ

–î–∞–Ω–Ω—ã–π –≥–∞–π–¥ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—å Jenkins –≤ Docker, –ø—Ä–∏ —ç—Ç–æ–º –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω Docker —Ö–æ—Å—Ç–æ–≤–æ–π –º–∞—à–∏–Ω—ã. –≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å CI/CD-–ø–∞–π–ø–ª–∞–π–Ω—ã —Å Docker –≤–Ω—É—Ç—Ä–∏ —Å–∞–º–æ–≥–æ Jenkins.
--

> **–û–ß–ï–ù–¨ –í–∞–∂–Ω–æ:** –ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –Ω–∞—á–∏–Ω–∞—Ç—å —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Jenkins —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –¥—Ä—É–≥–∏—Ö!!! –¢–∞–∫ –∫–∞–∫ jenkins –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–æ–∫–µ—Ä —Ö–æ—Å—Ç–æ–≤–æ–π –º–∞—à–∏–Ω—ã –ù–ï–õ–¨–ó–Ø –±—É–¥–µ—Ç –æ—Ç—Å–∞–≤–∏—Ç—å –ø—Ä–∏–ª–æ–¥–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ –∏ –∑–∞–ø—É—Å–∫–∞—Ç—å –µ–≥–æ –≤ jenkins(—ç—Ç–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É)

---


## 1. –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ Jenkins
–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ CI:

```
docker build -t myjenkins .
```

–≠—Ç–æ—Ç —à–∞–≥ —Å–æ–∑–¥–∞—Å—Ç –Ω–æ–≤—ã–π –æ–±—Ä–∞–∑ Docker —Å Jenkins, –≤ –∫–æ—Ç–æ—Ä–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Docker CLI.

## 2. –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Ç–∏ Docker
–î–ª—è —É–¥–æ–±–Ω–æ–≥–æ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–µ–∂–¥—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ —Å–æ–∑–¥–∞–π—Ç–µ Docker-—Å–µ—Ç—å:

```
docker network create jenkins
```
## 3. –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å Jenkins
–ó–∞–ø—É—Å—Ç–∏—Ç–µ Jenkins-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –ø–µ—Ä–µ–¥–∞–≤ –µ–º—É –¥–æ—Å—Ç—É–ø –∫ Docker —Ö–æ—Å—Ç–æ–≤–æ–π –º–∞—à–∏–Ω—ã:

```
docker run \
  --name jenkins-with-docker \
  --restart=on-failure \
  --detach \
  --network jenkins \
  --publish 8080:8080 \
  --publish 50000:50000 \
  --volume jenkins-data-flask:/var/jenkins_home \
  -v /var/run/docker.sock:/var/run/docker.sock \
  myjenkins
```
–ß—Ç–æ –∑–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:

–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏–º–µ–Ω—É–µ—Ç—Å—è jenkins-with-docker.
–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–±–æ–µ (--restart=on-failure).
–û—Ç–∫—Ä—ã—Ç—ã –ø–æ—Ä—Ç—ã:
8080 ‚Äî –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ Jenkins.
50000 ‚Äî –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤ Jenkins.
–•–æ—Å—Ç–æ–≤–æ–π Docker-—Å–æ–∫–µ—Ç –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (-v /var/run/docker.sock:/var/run/docker.sock), —á—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –≤–Ω—É—Ç—Ä–∏ Jenkins.
## 4. –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ Jenkins
–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É:

```
docker exec jenkins-with-docker cat /var/jenkins_home/secrets/initialAdminPassword
```
–ó–∞–ø–æ–º–Ω–∏—Ç–µ —ç—Ç–æ—Ç –ø–∞—Ä–æ–ª—å ‚Äî –æ–Ω –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–µ Jenkins.

## 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≥—Ä—É–ø–ø—ã Docker –≤–Ω—É—Ç—Ä–∏ Jenkins
–ß—Ç–æ–±—ã Jenkins –º–æ–≥ –∑–∞–ø—É—Å–∫–∞—Ç—å –ø–∞–π–ø–ª–∞–π–Ω—ã —Å Docker, –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è jenkins –≤ –≥—Ä—É–ø–ø—É docker.

–í–æ–π–¥–∏—Ç–µ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Ç –∏–º–µ–Ω–∏ root:

```
docker exec -it --user root jenkins-with-docker bash
```
–í–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã:

```
# –ú–µ–Ω—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ Docker-—Å–æ–∫–µ—Ç, —á—Ç–æ–±—ã –æ–±–µ—Å–ø–µ—á–∏—Ç—å –¥–æ—Å—Ç—É–ø
chmod 666 /var/run/docker.sock

# –í—ã—Ö–æ–¥ –∏–∑ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
exit
```
–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä:

```
docker restart jenkins-with-docker
```

## 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã Docker –≤–Ω—É—Ç—Ä–∏ Jenkins
–ü–æ—Å–ª–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Docker –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç:

```
docker exec jenkins-with-docker docker ps
```
–ï—Å–ª–∏ –∫–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫ ‚Äî Docker –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

## 7. –û—Ç–∫—Ä—ã—Ç–∏–µ Jenkins –≤ –±—Ä–∞—É–∑–µ—Ä–µ
–û—Ç–∫—Ä–æ–π—Ç–µ Jenkins –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ –∞–¥—Ä–µ—Å—É:


http://localhost:8080

–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –≤–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏–∑ —à–∞–≥–∞ 5.

## 8. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–ª–∞–≥–∏–Ω–æ–≤

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º—ã–µ –ø–ª–∞–≥–∏–Ω—ã –∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è


## 9. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Allure

–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Manage Jenkins -> Plugins -> Available plugins

–Ω–∞–π–¥–∏—Ç–µ Allure –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ

–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Manage Jenkins -> Tools -> Allure Commandline installations
–≤–≤–µ–¥–∏—Ç–µ allure –∏ –Ω–∞–∂–º–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å

–ø–æ—Å–ª–µ –¥–∞–Ω–Ω—ã—Ö –¥–µ–π—Ç—Å–≤–∏–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ jenkins
```
docker restart jenkins-with-docker
```


## 9. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –≤ Jenkins
–ó–∞–¥–∞—á–∞ –∑–∞–∫–ª—é—á–∞–µ—Ç—Å—è –≤ —Ç–æ–º, —á—Ç–æ–±—ã –¥–æ–±–∏—Ç—å—Å—è —É—Å–ø–µ—à–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Jenkins –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å –ª—é–±–æ–π —Ç–µ—Å—Ç –≤ –Ω–æ–≤–æ–π Jenkins-–¥–∂–æ–±–µ. –î–ª—è —ç—Ç–æ–≥–æ:

–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É (job) –≤ Jenkins.
–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –µ—ë —Ç–∞–∫, —á—Ç–æ–±—ã –∑–∞–ø—É—Å–∫–∞–ª–∏—Å—å —Ç–µ—Å—Ç—ã –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ (–ø—Ä–∏–º–µ—Ä –∑–∞–ø—É—Å–∫–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –≤ Jenkinsfile)

–ü—Ä–∏–º–µ—Ä 

http://localhost:8080/view/all/newJob

–≤–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø Pipeline

–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —á–µ–∫–±–æ–∫—Å GitHub hook trigger for GITScm polling

–í –ø–æ–ª–µ Pipeline -> Definition –≤—ã–±–µ—Ä–∏—Ç–µ Pipeline script from SCM

–≤ SCM - git

–≤ Branch Specifier - */main

–≤ Repository URL —É–∫–∞–∂–∏—Ç–µ –ª–∏–Ω–∫ —Å–æ–≤–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è


## 10. –ü—Ä–æ–±—Ä–æ—Å Webhook –¥–ª—è GitHub —Å –ø–æ–º–æ—â—å—é ngrok
–ß—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–µ–±—Ö—É–∫ –¥–ª—è GitHub, –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è ngrok.

–°–∫–∞—á–∞–π—Ç–µ –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ngrok.

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –ø—Ä–æ–±—Ä–æ—Å–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ä—Ç–∞:

```
ngrok http 8080
```

Ngrok –≤—ã–¥–∞—Å—Ç –ø—É–±–ª–∏—á–Ω—ã–π URL. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–µ–±—Ö—É–∫–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ GitHub.

## 11. –í—ã—Å—Ç–≤–ª–µ–Ω–∏–µ Webhook

–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Github –ø—Ä–æ–µ–∫—Ç -> Settings -> Webhooks

–≤ –ø–æ–ª–µ Payload URL –≤–≤–∏–¥–µ–∏—Ç–µ url –ø–æ–ª—É—á–µ–Ω–Ω—ã–π –Ω–∞ 10 —à–∞–≥–µ –¥–æ–±–∞–≤–∏–≤ –≤ –∫–æ–Ω—Ü–µ /github-webhook/

–ø—Ä–∏–º–µ—Ä:
```
https://7d23-209-206-23-75.ngrok-free.app/github-webhook/
```


–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–µ–π—Ç—Å–≤–∏–π —É –≤–∞—Å –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞—è –¥–∂–æ–±–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±–∞–∑–æ–≤—ã—Ö —Ç–µ—Å—Ç–æ–≤ –¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
